---
layout: page
title: 归档
permalink: /archive/
---

{%- assign all_posts = site.posts | concat: site.weeklies -%}
{%- assign sorted_posts = all_posts | sort: 'date' | reverse -%}

{%- assign post_count = site.posts | size -%}
{%- assign weekly_count = site.weeklies | size -%}
{%- assign total_count = post_count | plus: weekly_count -%}

{%- comment -%} 收集年份列表 {%- endcomment -%}
{% assign years = "" | split: "" %}
{% for post in sorted_posts %}
  {% assign y = post.date | date: "%Y" %}
  {% unless years contains y %}
    {% assign years = years | push: y %}
  {% endunless %}
{% endfor %}
{% assign years = years | sort | reverse %}

<!-- 第一行：类型过滤（文字链接） -->
<nav class="archive-filter mb-2" aria-label="Archive filters">
  <a href="#t=all"    class="filter-link is-active" data-filter="all">全部 ({{ total_count }})</a>
  <span class="mx-2">|</span>
  <a href="#t=post"   class="filter-link" data-filter="post">文章 ({{ post_count }})</a>
  <span class="mx-2">|</span>
  <a href="#t=weekly" class="filter-link" data-filter="weekly">周刊 ({{ weekly_count }})</a>
</nav>

<!-- 第二行：年份过滤（文字链接） -->
<nav class="year-filter mb-3" aria-label="Year filters">
  <a href="#y=all" class="year-link is-active" data-year="all">全部年份</a>
  {% for y in years %}
    <span class="mx-2">|</span>
    <a href="#y={{ y }}" class="year-link" data-year="{{ y }}">{{ y }}</a>
  {% endfor %}
</nav>

{%- assign year = nil -%}
{%- for post in sorted_posts -%}
  {%- capture currentyear -%}{{ post.date | date: "%Y" }}{%- endcapture -%}
  {%- if currentyear != year -%}
    {%- unless forloop.first -%}
        </ul></section>
    {%- endunless -%}
    <section class="year-block" data-year="{{ currentyear }}">
      <h3 class="post-archive-year">{{ currentyear }}</h3>
      <ul class="post-archive">
    {%- capture year -%}{{ currentyear }}{%- endcapture -%}
  {%- endif -%}

  {%- assign coll = post.collection | default: "" -%}
  {%- if coll == "posts" -%}
    {%- assign dtype = "post" -%}
    {%- assign badge = "文章" -%}
  {%- elsif coll == "weeklies" -%}
    {%- assign dtype = "weekly" -%}
    {%- assign badge = "周刊" -%}
  {%- else -%}
    {%- assign dtype = coll -%}
    {%- assign badge = coll -%}
  {%- endif -%}

  <li class="archive-item" data-type="{{ dtype }}">
    <span class="post-archive-badge" style="font-size:.8rem; color:#888; margin-right:.5rem;">{{ badge }}</span>
    <a href="{{ post.url | relative_url }}" class="post-archive-link">{{ post.title }}</a>
    <time class="post-archive-date" datetime="{{ post.date | date_to_xmlschema }}" style="margin-left:.5rem; color:#888;">
      {{ post.date | date: "%m-%d" }}
    </time>
  </li>
{%- endfor -%}
</ul></section>

<noscript>
  （已显示全部；启用 JavaScript 可使用“类型 / 年份”双重筛选。）
</noscript>

<style>
  .filter-link, .year-link { text-decoration:none; color:#6c757d; }
  .filter-link.is-active, .year-link.is-active { color:#0d6efd; font-weight:600; }
  .archive-item.is-hidden, .year-block.is-hidden { display:none !important; }
</style>

<script>
(function() {
  const typeLinks = Array.from(document.querySelectorAll('.filter-link'));
  const yearLinks = Array.from(document.querySelectorAll('.year-link'));
  const yearBlocks = Array.from(document.querySelectorAll('.year-block'));

  // 当前选择
  let selectedType = 'all'; // all | post | weekly
  let selectedYear = 'all'; // all | YYYY

  // 解析 hash：支持 #t=weekly&y=2024 / #y=2024&t=post / #t=all / #y=all 等
  function parseHash() {
    const h = (location.hash || '').replace(/^#/, '');
    const parts = h.split('&').filter(Boolean);
    const next = { t: selectedType, y: selectedYear };
    parts.forEach(p => {
      const [k,v] = p.split('=');
      if (k === 't' && v) next.t = v;
      if (k === 'y' && v) next.y = v;
    });
    selectedType = ['all','post','weekly'].includes(next.t) ? next.t : 'all';
    selectedYear = (next.y === 'all' || /^\d{4}$/.test(next.y)) ? next.y : 'all';
  }

  function updateHash() {
    const hash = `#t=${selectedType}&y=${selectedYear}`;
    if (location.hash !== hash) {
      if (history.replaceState) history.replaceState(null, '', hash);
      else location.hash = hash;
    }
  }

  function setActive(links, matchAttr, val) {
    links.forEach(a => {
      const isActive = a.getAttribute(matchAttr) === val ||
                      (val === 'all' && a.getAttribute(matchAttr) === 'all');
      a.classList.toggle('is-active', isActive);
    });
  }

  // 核心：同时应用类型与年份
  function applyFilters() {
    yearBlocks.forEach(block => {
      const blockYear = block.dataset.year;
      const yearMatch = (selectedYear === 'all') || (blockYear === selectedYear);

      let visibleCount = 0;
      const items = block.querySelectorAll('.archive-item');
      items.forEach(li => {
        const typeMatch = (selectedType === 'all') || (li.dataset.type === selectedType);
        const show = yearMatch && typeMatch;
        li.classList.toggle('is-hidden', !show);
        if (show) visibleCount++;
      });

      // 如果该年份下没有任何可见条目，隐藏整个年份块
      block.classList.toggle('is-hidden', visibleCount === 0);
    });

    // 更新“激活”样式
    setActive(typeLinks, 'data-filter', selectedType);
    setActive(yearLinks, 'data-year', selectedYear);
  }

  // 事件绑定
  typeLinks.forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      selectedType = a.dataset.filter || 'all';
      updateHash();
      applyFilters();
    });
  });

  yearLinks.forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      selectedYear = a.dataset.year || 'all';
      updateHash();
      applyFilters();
    });
  });

  // 初始化
  parseHash();
  updateHash();
  applyFilters();

  // 允许手动修改 hash 联动
  window.addEventListener('hashchange', () => {
    parseHash();
    applyFilters();
  });
})();
</script>
