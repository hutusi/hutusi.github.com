---
layout: page
title: 归档
permalink: /archive/
---

{%- assign all_posts = site.posts | concat: site.weeklies -%}
{%- assign sorted_posts = all_posts | sort: 'date' | reverse -%}

{%- assign post_count = site.posts | size -%}
{%- assign weekly_count = site.weeklies | size -%}
{%- assign total_count = post_count | plus: weekly_count -%}

<nav class="archive-filter" aria-label="Archive filters" style="margin-bottom:1rem;">
  <a href="#all" class="filter-link is-active" data-filter="all">全部 ({{ total_count }})</a>
  <span class="mx-2">|</span>
  <a href="#post" class="filter-link" data-filter="post">文章 ({{ post_count }})</a>
  <span class="mx-2">|</span>
  <a href="#weekly" class="filter-link" data-filter="weekly">周刊 ({{ weekly_count }})</a>
</nav>

{%- assign year = nil -%}
{%- for post in sorted_posts -%}
  {%- capture currentyear -%}{{ post.date | date: "%Y" }}{%- endcapture -%}
  {%- if currentyear != year -%}
    {%- unless forloop.first -%}
      </ul>
    {%- endunless -%}
    <h3 class="post-archive-year">{{ currentyear }}</h3>
    <ul class="post-archive">
    {%- capture year -%}{{ currentyear }}{%- endcapture -%}
  {%- endif -%}

  {%- comment -%} 判定集合，标记类型与徽章文字 {%- endcomment -%}
  {%- assign coll = post.collection | default: "" -%}
  {%- if coll == "posts" -%}
    {%- assign dtype = "post" -%}
    {%- assign badge = "文章" -%}
  {%- elsif coll == "weeklies" -%}
    {%- assign dtype = "weekly" -%}
    {%- assign badge = "周刊" -%}
  {%- else -%}
    {%- assign dtype = coll -%}
    {%- assign badge = coll -%}
  {%- endif -%}

  <li class="archive-item" data-type="{{ dtype }}">
    <span class="post-archive-badge" style="font-size:.8rem; color:#888; margin-right:.5rem;">{{ badge }}</span>
    <a href="{{ post.url | relative_url }}" class="post-archive-link">{{ post.title }}</a>
    <time class="post-archive-date" datetime="{{ post.date | date_to_xmlschema }}" style="margin-left:.5rem; color:#888;">
      {{ post.date | date: "%m-%d" }}
    </time>
  </li>
{%- endfor -%}
</ul>

<noscript>
  （已显示全部；启用 JavaScript 可使用“全部 / 文章 / 周刊”筛选。）
</noscript>

<style>
  .filter-link { text-decoration:none; color:#6c757d; }
  .filter-link.is-active { color:#0d6efd; font-weight:600; }
  .archive-item.is-hidden { display:none !important; }
</style>

<script>
(function() {
  const links = Array.from(document.querySelectorAll('.filter-link'));
  const items = Array.from(document.querySelectorAll('.archive-item'));
  if (!links.length || !items.length) return;

  function applyFilter(filter) {
    items.forEach(li => {
      const show = (filter === 'all') || (li.dataset.type === filter);
      li.classList.toggle('is-hidden', !show);
      li.style.display = show ? '' : 'none'; // 双保险
    });
  }

  function setActive(target) {
    links.forEach(a => a.classList.toggle('is-active', a === target));
  }

  links.forEach(a => {
    a.addEventListener('click', function(e) {
      e.preventDefault();
      const filter = this.dataset.filter;
      setActive(this);
      applyFilter(filter);
      if (history.replaceState) {
        history.replaceState(null, '', filter === 'all' ? '#all' : '#' + filter);
      } else {
        location.hash = filter;
      }
    });
  });

  // 初始根据 hash 预设；默认 all
  const hash = (location.hash || '#all').slice(1);
  const valid = ['all','post','weekly'];
  const initial = valid.includes(hash) ? hash : 'all';
  (document.querySelector(`.filter-link[data-filter="${initial}"]`) || links[0]).click();
})();
</script>
